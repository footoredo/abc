var danmu=[],buffer=[],displayed=new Array,api,danmu_check,last_check,gun,id_count=5,danmuplayerJQ,danmuplayer,playerJQ,player,on_the_run=[[],[],[]],video_id,normal_width,sleep=function(a){for(var b=(new Date).getTime(),c=0;1e7>c&&!((new Date).getTime()-b>a);c++);},get_velocity=function(a){return(770+a.width())/6e3},start_danmu=function(a){return a.hasClass("top")||a.hasClass("bottom")?void a.resume():(velocity=get_velocity(a),void a.animate({left:-a.width()},(a.position().left+a.width())/velocity,"linear",function(){a.remove()}))},stop_danmu=function(a){return a.hasClass("top")||a.hasClass("bottom")?void a.pause():void a.stop()},get_pos=function(a,b){for(a?on_the_run[a].forEach(function(a){0==$("#"+a[1].id).length&&(a[0]=-1)}):on_the_run[a].forEach(function(a){$(a[1]).position().left+$(a[1]).width()<=danmuplayerJQ.width()&&(a[0]=-1)}),on_the_run[a].sort(function(a,b){return a[0]<b[0]||a[0]==b[0]&&$(a[1]).position().top>$(b[1]).position().top?1:-1});on_the_run[a].length&&-1==on_the_run[a][on_the_run[a].length-1][0];)on_the_run[a].pop();var c,d=0,e=0;on_the_run[a][0]&&(d=on_the_run[a][0][0]);for(var f=0;f<on_the_run[a].length&&on_the_run[a][f][0]==d&&e+b>(c=parseInt(2==a?on_the_run[a][f][1].style.bottom:on_the_run[a][f][1].style.top));f++)e=c+$(on_the_run[a][f][1]).height();return e+b>playerJQ.height()&&(d++,e=0),[d,e]},shoot_danmu=function(a,b){if(!($("#"+a.id).length>0)){var c=a.context,d=document.createElement("div");d.setAttribute("class","bullet"+[""," top"," bottom"][a.danmu_type]+(b?" new":"")),d.id=a.id,d.innerHTML=c,d.style.color=a.danmu_color;var e=a.danmu_type;d.style.visibility="hidden",danmuplayer.appendChild(d);var f=get_pos(e,$(d).height());2>e?d.style.top=f[1]+"px":(d.style.top="auto",d.style.bottom=f[1]+"px"),e?d.style.left=(danmuplayerJQ.width()-$(d).width())/2+"px":d.style.left=danmuplayerJQ.width()+"px",d.style.visibility="visible",on_the_run[e].push([f[0],d]),1==e?$(d).animate({top:f[1]},3e3,function(){$(d).remove()}):2==e?$(d).animate({bottom:f[1]},3e3,function(){$(d).remove()}):start_danmu($(d)),api.paused&&stop_danmu($(d))}},buffer_timeout=function(a){return setTimeout(function(){api.paused||(shoot_danmu(danmu[a]),a+100<danmu.length&&buffer.push(buffer_timeout(a+100)),buffer.shift())},1e3*(danmu[a].send_time-api.video.time))},buffer_danmu=function(){if(!$(".danmuplayer").hasClass("hide")){for(var a=api.video.time,b=-1,c=0;c<danmu.length;c++)if(danmu[c].send_time-1e-6>a){b=c;break}if(!(0>b))for(var c=b;c<danmu.length&&100>c-b;c++)if(!buffer.find(function(a){a==danmu[c]})){var d=buffer_timeout(c);buffer.push(d)}}},clear_buffer=function(){for(;buffer.length;)clearTimeout(buffer[0]),buffer.shift()},init_player=function(){danmuplayer=document.createElement("div"),danmuplayer.setAttribute("class","danmuplayer"),danmuplayer.style.width=danmuplayer.style.height="100%",playerJQ=$(".fp-player"),player=document.getElementsByClassName("fp-player")[0],player.appendChild(danmuplayer),danmuplayerJQ=$(".danmuplayer")},sync_player=function(){danmuplayer.style.width=playerJQ.width()+"px",danmuplayer.style.height=playerJQ.height()+"px",danmuplayer.style.top=playerJQ.position().top+"px",danmuplayer.style.left=playerJQ.position().left+"px"};$(document).ready(function(){api=flowplayer(),api&&(video_id=$(".flowplayer").attr("id"),$.get("https://danmu.quack.press/get/video/"+video_id,function(a,b){danmu=JSON.parse(a),danmu=danmu.sort(function(a,b){return a.send_time-b.send_time}),console.log("Danmu loaded."),api.playing&&buffer_danmu()}),api.on("load",function(){init_player(),normal_width=$(".flowplayer").width()}),api.on("ready",function(){buffer_danmu()}),api.on("pause",function(){clear_buffer(),$(".bullet").each(function(){stop_danmu($(this))})}),api.on("resume",function(){$(".bullet").each(function(){start_danmu($(this))}),buffer_danmu()}),api.on("beforeseek",function(){api.playing?(clear_buffer(),$(".bullet").remove()):$(".bullet").remove()}),api.on("seek",function(){api.playing&&buffer_danmu()}),api.on("fullscreen",function(){$(".bullet").each(function(){stop_danmu($(this))}),api.playing&&$(".bullet").each(function(){start_danmu($(this))})}),api.on("fullscreen-exit",function(){$(".bullet").each(function(){stop_danmu($(this))}),api.playing&&$(".bullet").each(function(){start_danmu($(this))})}))});var fire_danmu=function(){var a=document.getElementsByClassName("danmu-bore")[0],b={};return b.send_time=api.video.time,b.context=a.value,b.danmu_type=$(".danmu-positioner-select").prop("selectedIndex"),b.danmu_color=$(".danmu-colorpicker-input").val(),b.danmu_size=1,b.video_id=video_id,b.user_id="",a.value.length>50?(alert("太长了傻逼"),!1):0==a.value.length?(alert("你没输傻逼"),!1):(a.value="",$.post("https://danmu.quack.press/send",b,function(a,c){b.id=a,shoot_danmu(b,!0),setTimeout(function(){danmu.push(b)},500)}),!1)},hide_danmu=function(){$(".danmuplayer").addClass("hide"),clear_buffer(),$(".bullet").remove()},show_danmu=function(){$(".danmuplayer").removeClass("hide"),api.playing&&buffer_danmu()};flowplayer(function(a,b){a.on("load",function(){$(".fp-controls").append($(".fp-fullscreen"));var b=document.createElement("div");b.setAttribute("class","danmu-controls"),$(".fp-ui").append(b);var c=document.createElement("div");c.setAttribute("class","danmu-styleboard"),b.appendChild(c);var d=document.createElement("span");d.setAttribute("class","danmu-colorpicker"),d.innerHTML="",c.appendChild(d);var e=document.createElement("input");e.setAttribute("class","danmu-colorpicker-input"),e.type="text",e.value="#fff",$(e).keyup(function(){$(d).css("color",$(this).val())}),c.appendChild(e),$(e).hide(),$(d).click(function(){$(e).is(":visible")?$(e).hide():$(e).show()});var f=document.createElement("span");f.setAttribute("class","danmu-positioner"),f.innerHTML="",c.appendChild(f);var g=document.createElement("select");g.setAttribute("class","danmu-positioner-select");var h=document.createElement("option");h.text="滚动弹幕",h.selected="selected",g.add(h);var i=document.createElement("option");i.text="顶端弹幕",g.add(i);var j=document.createElement("option");j.text="底端弹幕",g.add(j),c.appendChild(g),$(g).hide(),$(f).click(function(){$(g).is(":visible")?$(g).hide():$(g).show()});var k=document.createElement("form");k.setAttribute("class","danmu-gun"),k.setAttribute("onsubmit","return fire_danmu()"),b.appendChild(k);var l=document.createElement("a");l.setAttribute("class","danmu-toggle"),l.innerHTML="",l.onclick=function(){""==l.innerHTML?(l.innerHTML="",hide_danmu()):(l.innerHTML="",show_danmu())},document.getElementsByClassName("fp-controls")[0].appendChild(l);var m=document.createElement("input");m.setAttribute("class","danmu-styler"),m.type="button",m.value="",k.appendChild(m),$(c).hide(),$(m).click(function(){$(c).is(":visible")?$(c).hide():$(c).show()});var n=document.createElement("div");n.setAttribute("class","danmu-borecontainer"),k.appendChild(n);var o=document.createElement("input");o.type="text",o.setAttribute("class","danmu-bore"),o.placeholder="最多50个字～",n.appendChild(o);var p=document.createElement("input");p.type="submit",p.setAttribute("class","danmu-trigger"),p.value="",k.appendChild(p);var q=0,r=!1,s=-1,t=-1;a.on("fullscreen",function(){s=t=-1,$(window).on("mousemove",function(a){a.clientX==s&&a.clientY==t||(s=a.clientX,t=a.clientY,r&&($(".fp-controls,.fp-time").show(),$(".fp-ui").css("cursor","auto")),r=!1,q&&(clearTimeout(q),q=0),q=setTimeout(function(){r||($(".fp-controls,.fp-time").hide(),$(".fp-ui").css("cursor","none")),r=!0},2e3))}),$(window).trigger("mousemove")}),a.on("fullscreen-exit",function(){r&&($(".fp-controls,.fp-time").show(),$(".fp-ui").css("cursor","auto")),q&&(clearTimeout(q),q=0),$(window).off("mousemove")})})});